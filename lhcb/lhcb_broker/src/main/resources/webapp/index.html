<!--
  ~ Copyright [2015-2017] Fraunhofer Gesellschaft e.V., Institute for
  ~ Open Communication Systems (FOKUS)
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  ~
  -->

<html>
<head>
    <title>Last Hop Connectivity Broker - GUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="angular.js"></script>
</head>
<style>
    td {
        text-align: left;
        vertical-align: top;
    }
</style>
<body ng-app="lhcbgui" ng-controller="lhcbCtrl">
<h1>Last Hop Connectivity Broker - GUI</h1>

<p>Please select one of the available clients:
    <select name="singleSelect" ng-change="getClientInfo(client.endpoint)" ng-model="client"
            ng-options="client.endpoint for client in clients"></select>
</p>

<div>
    <div ng-show="client"
         style="font-family: monospace; background-color: lightgrey; display: inline-block; border: 2px solid; padding: 30px">
        <h2>Connectivity Monitoring: {{client.endpoint}}
            <button ng-click="getClientInfo(client.endpoint)">GET</button>
        </h2>
        <table border="1" ng-show="clientInfo">
            <tr ng-show="clientInfo[0]">
                <td>Network Bearer</td>
                <td>
                    <pre>{{clientInfo[0].value}}</pre>
                </td>
            </tr>
            <tr ng-show="clientInfo[1]">
                <td>Available Network Bearer</td>
                <td>
                    <pre>{{clientInfo[1].values | json}}</pre>
                </td>
            </tr>
            <tr ng-show="clientInfo[2]">
                <td>Radio Signal Strength</td>
                <td>
                    <pre>{{clientInfo[2].value}}</pre>
                </td>
            </tr>
            <tr ng-show="clientInfo[3]">
                <td>Link Quality</td>
                <td>
                    <pre>{{clientInfo[3].value}}</pre>
                </td>
            </tr>
            <tr ng-show="clientInfo[4]">
                <td>IP Addresses</td>
                <td>
                    <pre>{{clientInfo[4].values | json}}</pre>
                </td>
            </tr>
            <tr ng-show="clientInfo[5]">
                <td>Router IP Address</td>
                <td>
                    <pre>{{clientInfo[5].values | json}}</pre>
                </td>
            </tr>
            <tr ng-show="clientInfo[6]">
                <td>Link Utilization</td>
                <td>
                    <pre>{{clientInfo[6].value}}</pre>
                </td>
            </tr>
        </table>
        <p>
            <button ng-click="showRawInfo = !showRawInfo" ng-init="showRawInfo = false">Show/Hide raw client info
            </button>
        <pre ng-show="showRawInfo">{{clientInfo | json}}</pre>
        </p>
    </div>
</div>
</body>
<script>
    var app = angular.module("lhcbgui", []);
    app.controller("lhcbCtrl", function ($scope) {
        var makeRequest = function (type, value, client, cb) {
            console.log("makeRequest:", arguments);
            var http = new XMLHttpRequest();
            http.open("POST", "/.well-known");
            http.onreadystatechange = function (event) {

                var target = event.currentTarget;
                if (target.readyState === 4) {
                    if (target.status === 200) {
                        console.log("makeRequest ->", target.responseText);
                        cb(target.responseText);
                    } else {
                        console.log("Something went wrong because of response code: 200 != ", xhr.status);
                        console.log(target);
                    }
                }
            };
            var msg = {};
            msg.type = type;
            msg.value = value;
            msg.client = client;
            http.send(JSON.stringify(msg));
        };

        var getClientList = function () {
            console.log("getClientList");
            var callback = function (result) {
                var json = JSON.parse(result);
                $scope.clients = json.value;
                if ($scope.client == undefined && $scope.clients != undefined && $scope.clients.length > 0) {
                    $scope.client = $scope.clients[0];
                    getClientInfo($scope.client.endpoint);
                }
                $scope.$apply();
            };
            makeRequest("read", undefined, undefined, callback);
        };
//
//        var observeClientInfo = function () {
//            console.log("observeClientInfo");
//            var callback = function (result) {
//                var json = JSON.parse(result);
//                $scope.clients = json.value;
//                if ($scope.client == undefined && $scope.clients != undefined && $scope.clients.length > 0) {
//                    $scope.client = $scope.clients[0];
//                    getClientInfo($scope.client.endpoint);
//                }
//                $scope.$apply();
//            };
//            makeRequest("observe", undefined, undefined, callback);
//        }

        var getClientInfo = function (clientName) {
            console.log("getClientInfo", arguments);
            var callback = function (result) {
                var json = JSON.parse(result);
                $scope.clientInfo = json.value;
                console.log("clientInfo:", json.value);
                $scope.$apply();
            };
            makeRequest("read", undefined, clientName, callback);
        };

        $scope.getClientList = getClientList;
        $scope.getClientInfo = getClientInfo;


        getClientList();
    });
</script>
</html>